box: algas/wercker-mybox
build:
  services:
    - id: mysql
      env:
        MYSQL_RANDOM_ROOT_PASSWORD: yes
        MYSQL_USER: test
        MYSQL_PASSWORD: secret
        MYSQL_DATABASE: user
  steps:
    - script:
        name: env
        code: env
    - script:
        name: Wait for MySQL connection
        code: sleep 10s
    - script:
        name: migrate database
        code: |
          ./scripts/migrate.sh
    - script:
        name: run app
        code: |
          pip3 install tornado==4.4.2
          pip3 install mysqlclient==1.3.9
    - script:
        name: run app
        code: |
          python3 app.py
    - script:
        name: test
        code: |
          curl http://localhost:8888/user/1

dummy:
  steps:
    - script:
        name: dummy
        code: |
          echo 'hello'

migrate:
  steps:
    - pip-install
    - script:
        name: migrate database
        code: |
          ./scripts/migrate.sh
